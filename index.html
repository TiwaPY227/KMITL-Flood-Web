<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMITL FLOOD CENTER | KMITL</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <style>
        :root {
            --bg-color: #f4f7fa; --text-color: #1e293b; --card-bg: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.05); --heading-color: #0ea5e9;
            --border: #e2e8f0; --btn-bg: #ffffff; --btn-text: #475569;
            --clock-color: #64748b; 
            /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
            --font-main: 'Bebas Neue', cursive; 
            --font-sub: 'Inter', sans-serif;
        }
        body.dark-mode {
            --bg-color: #0f172a; --text-color: #f8fafc; --card-bg: #1e293b;
            --shadow: 0 4px 20px rgba(0,0,0,0.3); --heading-color: #38bdf8;
            --border: #334155; --btn-bg: #1e293b; --btn-text: #cbd5e1;
            --clock-color: #94a3b8;
        }
        * { box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; }
        
        /* ‡∏ô‡∏≥‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô */
        body { background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; min-height: 100vh; font-family: var(--font-sub); }
        h1, h2, #clock, .chip, .node-title-badge, .ai-value { font-family: var(--font-main); letter-spacing: 1px; }

        .top-nav { 
            padding: 10px 30px; display: flex; align-items: center; 
            border-bottom: 1px solid var(--border); background: var(--card-bg); 
            position: sticky; top: 0; z-index: 1000; height: 75px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .logo-ins { width: 140px; height: auto; }
        
        .datetime-container { margin-left: auto; margin-right: 20px; text-align: right; border-right: 2px solid var(--border); padding-right: 20px; }
        #clock { font-size: 2rem; color: var(--heading-color); line-height: 1; }
        #date { font-size: 0.85rem; color: var(--clock-color); font-weight: 600; letter-spacing: 1px; }

        .logo-kmitl { position: fixed; bottom: 20px; right: 20px; width: 120px; z-index: 2000; opacity: 0.5; filter: grayscale(100%); transition: 0.3s; }
        .logo-kmitl:hover { opacity: 1; filter: grayscale(0%); }
        .theme-toggle-btn { padding: 8px 18px; border-radius: 20px; border: 1px solid var(--border); background: var(--btn-bg); color: var(--btn-text); cursor: pointer; font-size: 1.1rem; }

        .hero { text-align: center; padding: 30px 20px 20px; overflow: hidden; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ */
        
        /* üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô üåü */
        .subject-title {
            font-size: clamp(1rem, 2.2vw, 1.8rem); /* ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏à‡∏≠ */
            margin: 0;
            line-height: 1.1;
            color: var(--text-color); 
            font-family: var(--font-sub); 
            font-weight: 800; 
            white-space: nowrap; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
        }
        
        .main-title { font-size: 1.2rem; color: var(--heading-color); margin-top: 12px; font-weight: 600; }

        .main-content { max-width: 1200px; margin: 0 auto; padding: 0 20px 40px; }
        
        .tab-nav-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .page-tab-btn { 
            padding: 12px 40px; border-radius: 30px; border: 2px solid var(--heading-color); 
            background: var(--bg-color); color: var(--text-color); font-family: var(--font-main); 
            font-size: 1.5rem; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow);
            letter-spacing: 1px;
        }
        .page-tab-btn.active { background: var(--heading-color); color: #ffffff; transform: scale(1.05); }
        .page-tab-btn:hover:not(.active) { background: var(--card-bg); border-color: var(--text-color); }
        
        .view-section { display: none; animation: fadeIn 0.5s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .video-wrapper { 
            position: relative; padding-bottom: 56.25%;
            height: 0; overflow: hidden; border-radius: 12px; border: 1px solid var(--border);
            box-shadow: var(--shadow); background: #000;
        }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .line-banner { 
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; 
            padding: 16px 24px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; 
            box-shadow: var(--shadow); font-weight: 600; font-size: 1.1rem;
        }
        .line-banner.alert { background: #fee2e2; border-color: #ef4444; color: #b91c1c; animation: pulse-bg 2s infinite; }
        body.dark-mode .line-banner.alert { background: #7f1d1d; border-color: #ef4444; color: #fca5a5; }
        .line-icon { font-size: 1.5rem; }

        .node-group { margin-bottom: 40px; }
        .node-title-badge { display: inline-block; background: var(--text-color); color: var(--bg-color); font-size: 1.8rem; padding: 5px 20px; border-radius: 8px 8px 0 0; letter-spacing: 2px;}

        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; }
        
        .data-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); }
        .ai-card { position: relative; overflow: hidden; }
        .ai-icon-bg { position: absolute; right: -10px; bottom: -20px; font-size: 9rem; opacity: 0.03; pointer-events: none; color: var(--text-color); transition: color 0.3s; }

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 12px; margin-bottom: 15px; }
        .card-header h2 { margin: 0; font-size: 2rem; color: var(--heading-color); }
        .card-header-center { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        .card-header-center h2 { margin: 0; font-size: 2.5rem; color: var(--text-color); letter-spacing: 2px;}
        
        .row { display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; padding: 12px 0; border-bottom: 1px solid var(--border); font-weight: 600; }
        .row:last-child { border: none; padding-bottom: 0; }
        .val { font-size: 1.2rem; color: var(--text-color); font-weight: 800; }

        .ai-box { text-align: center; padding: 15px 0; }
        .ai-label { font-size: 1rem; color: var(--clock-color); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;}
        
        .ai-value { 
            font-size: 1.6rem; 
            font-family: var(--font-sub); 
            font-weight: 600;
            color: var(--text-color); 
            line-height: 1.3; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .divider { border-top: 1px dashed var(--border); margin: 10px 0; }

        .badge { padding: 6px 14px; border-radius: 8px; font-size: 0.9rem; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px; }
        .badge-status { padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 800; color: white; }
        
        .bg-safe { background: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .bg-high { background: #f59e0b; box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        .bg-danger { background: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); animation: pulse 1.5s infinite; }
        .bg-online { background: #10b981; }
        .bg-offline { background: #64748b; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes pulse-bg { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .section-box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 30px; box-shadow: var(--shadow); }
        .map-controls { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; }
        .chip { padding: 8px 28px; border-radius: 30px; border: 1px solid var(--border); background: var(--btn-bg); color: var(--btn-text); cursor: pointer; font-size: 1.3rem; }
        .chip.active { background: var(--heading-color); color: white; border-color: var(--heading-color); }
        
        .map-container { position: relative; height: 500px; width: 100%; border-radius: 12px; overflow: hidden; border: 2px solid var(--border);}
        .map-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; visibility: hidden; opacity: 0; z-index: 1; transition: opacity 0.4s ease; }
        .map-view.active { visibility: visible; opacity: 1; z-index: 2; }
        body.dark-mode .leaflet-tile-pane { filter: invert(90%) hue-rotate(180deg) brightness(95%) contrast(90%); }
    </style>
</head>
<body>
    <nav class="top-nav">
        <img src="https://drive.google.com/thumbnail?id=149d-Q-SSJN4EJJAfdYuJa6DkCEXodLJo&sz=w1000" alt="INS Logo" class="logo-ins">
        <div class="datetime-container">
            <div id="clock">00:00:00</div>
            <div id="date">LOADING DATE...</div>
        </div>
        <button class="theme-toggle-btn" onclick="toggleTheme()">üåì THEME</button>
    </nav>

    <img src="https://lh3.googleusercontent.com/d/1WG8pYZieZcT26dsyNxzjH0wwewbm5Kgk" alt="KMITL Logo" class="logo-kmitl">

    <div class="hero">
        <h1 class="subject-title">INDUSTRIAL DATA COMMUNICATIONS AND DISTRIBUTED CONTROL SYSTEM</h1>
        <p class="main-title">WATER LEVEL & RAIN MONITORING SYSTEM</p>
    </div>

    <div class="main-content">
        
        <div class="tab-nav-container">
            <button class="page-tab-btn active" onclick="switchPageView('dashboard_view', this)">üìä DASHBOARD</button>
            <button class="page-tab-btn" onclick="switchPageView('video_view', this)">üé• VIDEO</button>
            <button class="page-tab-btn" onclick="switchPageView('canva_view', this)">üìë PRESENTATION</button>
        </div>

        <div id="dashboard_view" class="view-section active">
            
            <div id="line_banner" class="line-banner">
                <span id="line_icon" class="line-icon">üí¨</span>
                <span id="line_text">LINE STATUS: STANDBY (NORMAL)</span>
            </div>

            <div class="node-group">
                <div class="node-title-badge">STATION: NODE 1</div>
                <div class="card-grid">
                    <div class="data-card">
                        <div class="card-header">
                            <h2>SYSTEM STATUS</h2>
                            <span id="n1_status" class="badge-status bg-offline">OFFLINE</span>
                        </div>
                        <div class="row"><span>WARNING LEVEL:</span><span id="n1_warn" class="badge bg-safe">-</span></div>
                        <div class="row"><span>WATER LEVEL:</span><span id="n1_water" class="val">- %</span></div>
                        <div class="row"><span>RAIN STATUS:</span><span id="n1_rain" class="val">-</span></div>
                        <div class="row"><span>TEMP / PRESS:</span><span class="val" id="n1_env">0.0 ¬∞C / 0.0 hPa</span></div>
                        <div class="row"><span>LAT / LNG:</span><span class="val" id="n1_pos">0.0, 0.0</span></div>
                    </div>
                    
                    <div class="data-card ai-card">
                        <div class="ai-icon-bg">ü§ñ</div>
                        <div class="card-header">
                            <h2>AI PREDICTION</h2>
                            <span class="badge bg-online">LIVE AI</span>
                        </div>
                        <div class="ai-box">
                            <div class="ai-label">‚òÅÔ∏è WEATHER FORECAST</div>
                            <div class="ai-value" id="n1_ai_weather">ANALYZING...</div>
                        </div>
                        <div class="divider"></div>
                        <div class="ai-box">
                            <div class="ai-label">üåä FLOOD RISK ASSESSMENT</div>
                            <div class="ai-value" id="n1_ai_risk">ANALYZING...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="node-group">
                <div class="node-title-badge">STATION: NODE 2</div>
                <div class="card-grid">
                    <div class="data-card">
                        <div class="card-header">
                            <h2>SYSTEM STATUS</h2>
                            <span id="n2_status" class="badge-status bg-offline">OFFLINE</span>
                        </div>
                        <div class="row"><span>WARNING LEVEL:</span><span id="n2_warn" class="badge bg-safe">-</span></div>
                        <div class="row"><span>WATER LEVEL:</span><span id="n2_water" class="val">- %</span></div>
                        <div class="row"><span>RAIN STATUS:</span><span id="n2_rain" class="val">-</span></div>
                        <div class="row"><span>TEMP / PRESS:</span><span class="val" id="n2_env">0.0 ¬∞C / 0.0 hPa</span></div>
                        <div class="row"><span>LAT / LNG:</span><span class="val" id="n2_pos">0.0, 0.0</span></div>
                    </div>

                    <div class="data-card ai-card">
                        <div class="ai-icon-bg">ü§ñ</div>
                        <div class="card-header">
                            <h2>AI PREDICTION</h2>
                            <span class="badge bg-online">LIVE AI</span>
                        </div>
                        <div class="ai-box">
                            <div class="ai-label">‚òÅÔ∏è WEATHER FORECAST</div>
                            <div class="ai-value" id="n2_ai_weather">ANALYZING...</div>
                        </div>
                        <div class="divider"></div>
                        <div class="ai-box">
                            <div class="ai-label">üåä FLOOD RISK ASSESSMENT</div>
                            <div class="ai-value" id="n2_ai_risk">ANALYZING...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-box">
                <div class="card-header-center">
                    <h2>üåä LEVEL / DISTANCE</h2>
                </div>
                <div class="map-controls">
                    <button id="btn_water_lvl" class="chip active" onclick="switchWaterChart('level')">üåä WATER LEVEL</button>
                    <button id="btn_water_dist" class="chip" onclick="switchWaterChart('dist')">üìè DISTANCE</button>
                </div>
                <div style="position: relative; height: 400px; width: 100%;">
                    <canvas id="waterChart"></canvas>
                </div>
            </div>

            <div class="section-box">
                <div class="card-header-center">
                    <h2>üå°Ô∏è ENVIRONMENT : TEMP / PRESS</h2>
                </div>
                <div class="map-controls">
                    <button id="btn_env_temp" class="chip active" onclick="switchEnvChart('temp')">üå°Ô∏è TEMPERATURE</button>
                    <button id="btn_env_press" class="chip" onclick="switchEnvChart('press')">‚òÅÔ∏è PRESSURE</button>
                </div>
                <div style="position: relative; height: 400px; width: 100%;">
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <div class="section-box">
                <div class="card-header-center">
                    <h2>üìç LOCATION & FLOOD MAP</h2>
                </div>
                
                <div class="map-controls">
                    <button id="btn_node1" class="chip active" onclick="switchNode(1)">üìç STATION: NODE 1</button>
                    <button id="btn_node2" class="chip" onclick="switchNode(2)">üìç STATION: NODE 2</button>
                </div>

                <div class="map-controls" style="margin-bottom: 20px;">
                    <button id="btn_mode_std" class="chip active" onclick="switchMode('std')" style="font-size: 1rem; padding: 6px 20px;">üó∫Ô∏è STANDARD MAP</button>
                    <button id="btn_mode_flood" class="chip" onclick="switchMode('flood')" style="font-size: 1rem; padding: 6px 20px;">üåä FLOOD MAN MAP</button>
                </div>

                <div class="map-container">
                    <div id="map_n1_std" class="map-view active"></div>
                    <div id="map_n1_flood" class="map-view"></div>
                    <div id="map_n2_std" class="map-view"></div>
                    <div id="map_n2_flood" class="map-view"></div>
                </div>
            </div>

        </div> 
        
        <div id="video_view" class="view-section">
            <div class="section-box">
                <div class="card-header-center">
                    <h2>DEMO / TEST MONITORING</h2>
                </div>
                <div class="video-wrapper">
                    <iframe id="youtube-player" src="https://www.youtube.com/embed/UprcpdwuwCg?si=2dLBmbJ7f4gVNUzr&autoplay=1&mute=1&controls=1&rel=0&enablejsapi=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                </div>
            </div>
        </div> 

        <div id="canva_view" class="view-section">
            <div class="section-box">
                <div class="card-header-center">
                    <h2>PRESENTATION</h2>
                </div>
                <div class="video-wrapper">
                    <iframe loading="lazy" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: none; padding: 0; margin: 0;"
                        src="https://www.canva.com/design/DAFydueDV3E/view?embed" allowfullscreen="allowfullscreen" allow="fullscreen">
                    </iframe>
                </div>
                <p style="text-align: center; margin-top: 15px; font-weight: 500; color: var(--clock-color);">
                    üí° ‡∏á‡∏≤‡∏ô‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏à‡∏≤‡∏Å Canva ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
                </p>
            </div>
        </div>

    </div>

    <script>
        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        void function updateTime() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('th-TH', { hour12: false });
            document.getElementById('date').innerText = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase();
            setTimeout(updateTime, 1000);
        }();

        let ytPlayer;
        function onYouTubeIframeAPIReady() { ytPlayer = new YT.Player('youtube-player'); }

        function switchPageView(viewId, btnElement) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.page-tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            btnElement.classList.add('active');
            
            setTimeout(() => {
                if(normalMap1) normalMap1.invalidateSize();
                if(normalMap2) normalMap2.invalidateSize();
                if(floodMap1) floodMap1.invalidateSize();
                if(floodMap2) floodMap2.invalidateSize();
            }, 100);
        }

        // ==========================================
        // ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Leaflet (‡∏ü‡∏£‡∏µ 100%)
        // ==========================================
        let normalMap1, normalMap2, floodMap1, floodMap2;
        let normalMarker1, normalMarker2, floodMarker1, floodMarker2;
        let floodCircle1, floodCircle2;
        let currentNode = 1;
        let currentMode = 'std'; 

        document.addEventListener('DOMContentLoaded', () => {
            const defaultPos = [13.7278, 100.7725]; 
            const tileLayerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'; 
            const tileLayerAttribution = '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

            normalMap1 = L.map('map_n1_std').setView(defaultPos, 16);
            L.tileLayer(tileLayerUrl, { attribution: tileLayerAttribution }).addTo(normalMap1);
            normalMarker1 = L.marker(defaultPos).addTo(normalMap1).bindPopup("<b>STATION 1</b>");

            floodMap1 = L.map('map_n1_flood').setView(defaultPos, 16);
            L.tileLayer(tileLayerUrl, { attribution: tileLayerAttribution }).addTo(floodMap1);
            floodMarker1 = L.marker(defaultPos).addTo(floodMap1);
            floodCircle1 = L.circle(defaultPos, { color: '#10b981', fillColor: '#10b981', fillOpacity: 0.35, radius: 0 }).addTo(floodMap1);

            normalMap2 = L.map('map_n2_std').setView(defaultPos, 16);
            L.tileLayer(tileLayerUrl, { attribution: tileLayerAttribution }).addTo(normalMap2);
            normalMarker2 = L.marker(defaultPos).addTo(normalMap2).bindPopup("<b>STATION 2</b>");

            floodMap2 = L.map('map_n2_flood').setView(defaultPos, 16);
            L.tileLayer(tileLayerUrl, { attribution: tileLayerAttribution }).addTo(floodMap2);
            floodMarker2 = L.marker(defaultPos).addTo(floodMap2);
            floodCircle2 = L.circle(defaultPos, { color: '#10b981', fillColor: '#10b981', fillOpacity: 0.35, radius: 0 }).addTo(floodMap2);
            
            setTimeout(() => { normalMap1.invalidateSize(); floodMap1.invalidateSize(); }, 500);
        });

        function updateMapVisibility() {
            document.querySelectorAll('.map-view').forEach(el => el.classList.remove('active'));

            if(currentNode === 1 && currentMode === 'std') { document.getElementById('map_n1_std').classList.add('active'); setTimeout(()=>normalMap1.invalidateSize(), 50); }
            if(currentNode === 1 && currentMode === 'flood') { document.getElementById('map_n1_flood').classList.add('active'); setTimeout(()=>floodMap1.invalidateSize(), 50); }
            if(currentNode === 2 && currentMode === 'std') { document.getElementById('map_n2_std').classList.add('active'); setTimeout(()=>normalMap2.invalidateSize(), 50); }
            if(currentNode === 2 && currentMode === 'flood') { document.getElementById('map_n2_flood').classList.add('active'); setTimeout(()=>floodMap2.invalidateSize(), 50); }
        }

        function switchNode(id) {
            currentNode = id;
            document.getElementById('btn_node1').classList.toggle('active', id === 1);
            document.getElementById('btn_node2').classList.toggle('active', id === 2);
            updateMapVisibility();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('btn_mode_std').classList.toggle('active', mode === 'std');
            document.getElementById('btn_mode_flood').classList.toggle('active', mode === 'flood');
            updateMapVisibility();
        }

        function updateFloodAnMap(map, circle, marker, lat, lng, percentage) {
            if (lat != 0 && lng != 0) {
                const pos = [lat, lng]; 
                marker.setLatLng(pos); 
                circle.setLatLng(pos); 
                map.setView(pos, 16); 
                circle.setRadius(percentage * 2.5); 
                
                let color = "#10b981"; 
                if (percentage >= 80) color = "#ef4444"; 
                else if (percentage >= 50) color = "#f59e0b"; 
                
                circle.setStyle({color: color, fillColor: color});
            }
        }
        // ==========================================

        let waterLabels = [];
        let levelDataN1 = [], levelDataN2 = [];
        let distDataN1 = [], distDataN2 = [];
        let currentWaterMode = 'level';

        const ctxWater = document.getElementById('waterChart').getContext('2d');
        const waterChart = new Chart(ctxWater, {
            type: 'line',
            data: {
                labels: waterLabels,
                datasets: [
                    { label: 'NODE 1 (%)', borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', data: levelDataN1, tension: 0.4, fill: true },
                    { label: 'NODE 2 (%)', borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', data: levelDataN2, tension: 0.4, fill: true }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });

        function switchWaterChart(mode) {
            currentWaterMode = mode;
            document.getElementById('btn_water_lvl').classList.toggle('active', mode === 'level');
            document.getElementById('btn_water_dist').classList.toggle('active', mode === 'dist');

            if(mode === 'level') {
                waterChart.data.datasets[0].label = 'NODE 1 (%)';
                waterChart.data.datasets[0].data = levelDataN1;
                waterChart.data.datasets[0].borderColor = '#0ea5e9';
                waterChart.data.datasets[0].backgroundColor = 'rgba(14, 165, 233, 0.1)';
                
                waterChart.data.datasets[1].label = 'NODE 2 (%)';
                waterChart.data.datasets[1].data = levelDataN2;
                waterChart.data.datasets[1].borderColor = '#f59e0b';
                waterChart.data.datasets[1].backgroundColor = 'rgba(245, 158, 11, 0.1)';
                waterChart.options.scales.y.max = 100;
            } else {
                waterChart.data.datasets[0].label = 'NODE 1 (cm)';
                waterChart.data.datasets[0].data = distDataN1;
                waterChart.data.datasets[0].borderColor = '#8b5cf6';
                waterChart.data.datasets[0].backgroundColor = 'rgba(139, 92, 246, 0.1)';
                
                waterChart.data.datasets[1].label = 'NODE 2 (cm)';
                waterChart.data.datasets[1].data = distDataN2;
                waterChart.data.datasets[1].borderColor = '#10b981';
                waterChart.data.datasets[1].backgroundColor = 'rgba(16, 185, 129, 0.1)';
                delete waterChart.options.scales.y.max; 
            }
            waterChart.update();
        }

        let envLabels = [];
        let tempDataN1 = [], tempDataN2 = [];
        let pressDataN1 = [], pressDataN2 = [];
        let currentEnvMode = 'temp';

        const ctxEnv = document.getElementById('envChart').getContext('2d');
        const envChart = new Chart(ctxEnv, {
            type: 'line',
            data: {
                labels: envLabels,
                datasets: [
                    { label: 'NODE 1 (¬∞C)', borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', data: tempDataN1, tension: 0.4, fill: true },
                    { label: 'NODE 2 (¬∞C)', borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', data: tempDataN2, tension: 0.4, fill: true }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
        });

        function switchEnvChart(mode) {
            currentEnvMode = mode;
            document.getElementById('btn_env_temp').classList.toggle('active', mode === 'temp');
            document.getElementById('btn_env_press').classList.toggle('active', mode === 'press');

            if(mode === 'temp') {
                envChart.data.datasets[0].label = 'NODE 1 (¬∞C)';
                envChart.data.datasets[0].data = tempDataN1;
                envChart.data.datasets[0].borderColor = '#ef4444';
                envChart.data.datasets[0].backgroundColor = 'rgba(239, 68, 68, 0.1)';
                
                envChart.data.datasets[1].label = 'NODE 2 (¬∞C)';
                envChart.data.datasets[1].data = tempDataN2;
                envChart.data.datasets[1].borderColor = '#3b82f6';
                envChart.data.datasets[1].backgroundColor = 'rgba(59, 130, 246, 0.1)';
            } else {
                envChart.data.datasets[0].label = 'NODE 1 (hPa)';
                envChart.data.datasets[0].data = pressDataN1;
                envChart.data.datasets[0].borderColor = '#8b5cf6';
                envChart.data.datasets[0].backgroundColor = 'rgba(139, 92, 246, 0.1)';
                
                envChart.data.datasets[1].label = 'NODE 2 (hPa)';
                envChart.data.datasets[1].data = pressDataN2;
                envChart.data.datasets[1].borderColor = '#10b981';
                envChart.data.datasets[1].backgroundColor = 'rgba(16, 185, 129, 0.1)';
            }
            envChart.update();
        }

        function getWarningBadge(percentage) {
            if(percentage >= 80) return `<span class="badge bg-danger">DANGER</span>`;
            if(percentage >= 50) return `<span class="badge bg-high">HIGH</span>`;
            return `<span class="badge bg-safe">SAFE</span>`;
        }

        function getStatusBadge(t) {
            if(t > 10) return `<span class="badge-status bg-offline">OFFLINE</span>`;
            return `<span class="badge-status bg-online">ONLINE</span>`;
        }

        function setRiskColor(elementId, text) {
            const el = document.getElementById(elementId);
            el.innerHTML = text; 
            if (text.includes("LOW") || text.includes("CLEAR") || text.includes("NORMAL") || text.includes("SAFE")) el.style.color = "#10b981"; 
            else if (text.includes("MODERATE") || text.includes("LIKELY")) el.style.color = "#f59e0b"; 
            else if (text.includes("HIGH") || text.includes("IMMINENT") || text.includes("STORM") || text.includes("CRITICAL") || text.includes("DANGER") || text.includes("SEVERE") || text.includes("RISING")) el.style.color = "#ef4444"; 
            else el.style.color = "var(--text-color)";
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxcs2FdoWIQAqQh5Naqxy77KhFJ6U3RdQ",
            authDomain: "kmitl-flood-center.firebaseapp.com",
            databaseURL: "https://kmitl-flood-center-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kmitl-flood-center",
            storageBucket: "kmitl-flood-center.firebasestorage.app",
            messagingSenderId: "429876816215",
            appId: "1:429876816215:web:474caa2cbfe84a318df612",
            measurementId: "G-BSZCH7EY2C"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        db.ref("/").on("value", (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            const getVal = (obj, key, fallback) => (obj && obj[key] !== undefined) ? obj[key] : fallback;

            let p1 = getVal(data.node1, 'p', 0), r1 = getVal(data.node1, 'r', 0);
            let te1 = getVal(data.node1, 'te', 0.0), pr1 = getVal(data.node1, 'pr', 0.0);
            let la1 = getVal(data.node1, 'la', 0.0), lo1 = getVal(data.node1, 'lo', 0.0);
            let t1 = getVal(data.node1, 't', 99), d1 = getVal(data.node1, 'd', 0);
            let ai_w1 = getVal(data.node1, 'ai_w', "WAITING DATA"), ai_r1 = getVal(data.node1, 'ai_r', "WAITING DATA");

            let p2 = getVal(data.node2, 'p', 0), r2 = getVal(data.node2, 'r', 0);
            let te2 = getVal(data.node2, 'te', 0.0), pr2 = getVal(data.node2, 'pr', 0.0);
            let la2 = getVal(data.node2, 'la', 0.0), lo2 = getVal(data.node2, 'lo', 0.0);
            let t2 = getVal(data.node2, 't', 99), d2 = getVal(data.node2, 'd', 0);
            let ai_w2 = getVal(data.node2, 'ai_w', "WAITING DATA"), ai_r2 = getVal(data.node2, 'ai_r', "WAITING DATA");

            document.getElementById('n1_water').innerText = p1 + " %";
            document.getElementById('n1_rain').innerText = r1 > 0 ? "RAINING" : "DRY";
            document.getElementById('n1_env').innerText = Number(te1).toFixed(1) + " ¬∞C / " + Number(pr1).toFixed(1) + " hPa";
            document.getElementById('n1_pos').innerText = Number(la1).toFixed(4) + ", " + Number(lo1).toFixed(4);
            document.getElementById('n1_warn').innerHTML = getWarningBadge(p1);
            document.getElementById('n1_status').innerHTML = getStatusBadge(t1);
            setRiskColor('n1_ai_weather', ai_w1);
            setRiskColor('n1_ai_risk', ai_r1);

            document.getElementById('n2_water').innerText = p2 + " %";
            document.getElementById('n2_rain').innerText = r2 > 0 ? "RAINING" : "DRY";
            document.getElementById('n2_env').innerText = Number(te2).toFixed(1) + " ¬∞C / " + Number(pr2).toFixed(1) + " hPa";
            document.getElementById('n2_pos').innerText = Number(la2).toFixed(4) + ", " + Number(lo2).toFixed(4);
            document.getElementById('n2_warn').innerHTML = getWarningBadge(p2);
            document.getElementById('n2_status').innerHTML = getStatusBadge(t2);
            setRiskColor('n2_ai_weather', ai_w2);
            setRiskColor('n2_ai_risk', ai_r2);

            let lineBanner = document.getElementById('line_banner');
            document.getElementById('line_text').innerText = "LINE STATUS: " + getVal(data.line, 'msg', "STANDBY (NORMAL)");
            if(getVal(data.line, 'alert', false)) {
                lineBanner.classList.add('alert');
                document.getElementById('line_icon').innerText = 'üîî';
            } else {
                lineBanner.classList.remove('alert');
                document.getElementById('line_icon').innerText = 'üí¨';
            }

            let t = new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            if(waterLabels.length > 20) { 
                waterLabels.shift(); levelDataN1.shift(); levelDataN2.shift(); distDataN1.shift(); distDataN2.shift();
                envLabels.shift(); tempDataN1.shift(); tempDataN2.shift(); pressDataN1.shift(); pressDataN2.shift();
            }
            waterLabels.push(t); levelDataN1.push(p1); levelDataN2.push(p2); distDataN1.push(d1); distDataN2.push(d2);
            envLabels.push(t); tempDataN1.push(Number(te1)); tempDataN2.push(Number(te2)); pressDataN1.push(Number(pr1)); pressDataN2.push(Number(pr2));
            waterChart.update(); envChart.update();

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Leaflet ‡∏ï‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å ESP32
            if(la1 != 0 && normalMarker1) { const pos1 = [la1, lo1]; normalMarker1.setLatLng(pos1); normalMap1.setView(pos1, 16); }
            if(la2 != 0 && normalMarker2) { const pos2 = [la2, lo2]; normalMarker2.setLatLng(pos2); normalMap2.setView(pos2, 16); }
            if(la1 != 0 && floodMarker1) updateFloodAnMap(floodMap1, floodCircle1, floodMarker1, la1, lo1, p1);
            if(la2 != 0 && floodMarker2) updateFloodAnMap(floodMap2, floodCircle2, floodMarker2, la2, lo2, p2);
        });
    </script>
</body>
</html>